---
// src/pages/admin/index.astro
import AdminLayout from '../../layouts/AdminLayout.astro';
import AlertSystem from '../../components/ui/AlertSystem.astro';
---

<AdminLayout title="Dashboard Admin">
  <AlertSystem />

  <style is:global>
    @media print {
      body * { visibility: hidden; }
      #pdf-template, #pdf-template * { visibility: visible; }
      #pdf-template {
        position: absolute;
        left: 0; top: 0; width: 100%;
        display: block !important;
        background: white;
        padding: 20px;
      }
      /* Pastikan elemen lain hilang */
      nav, aside, .no-print { display: none !important; }
    }
  </style>

  <div class="mb-8 no-print">
    <h1 class="text-3xl font-bold text-gray-800">Dashboard Overview</h1>
    <p class="text-gray-500 mt-1">Pantau perkembangan potensi akademik siswa.</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 no-print">
    <div class="card bg-white shadow-sm border border-gray-200">
      <div class="card-body flex flex-row items-center justify-between">
        <div>
            <h2 class="card-title text-gray-500 text-sm">Total Guru Aktif</h2>
            <p class="text-4xl font-extrabold text-primary mt-2" id="stat-guru">...</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary"><i class="fa-solid fa-chalkboard-user text-xl"></i></div>
      </div>
    </div>
    <div class="card bg-white shadow-sm border border-gray-200">
      <div class="card-body flex flex-row items-center justify-between">
        <div>
            <h2 class="card-title text-gray-500 text-sm">Total Siswa</h2>
            <p class="text-4xl font-extrabold text-secondary mt-2" id="stat-siswa">...</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-secondary/10 flex items-center justify-center text-secondary"><i class="fa-solid fa-user-graduate text-xl"></i></div>
      </div>
    </div>
    <div class="card bg-white shadow-sm border border-gray-200">
      <div class="card-body flex flex-row items-center justify-between">
        <div>
            <h2 class="card-title text-gray-500 text-sm">Total Kelas</h2>
            <p class="text-4xl font-extrabold text-accent mt-2" id="stat-kelas">...</p>
        </div>
        <div class="w-12 h-12 rounded-full bg-accent/10 flex items-center justify-center text-accent"><i class="fa-solid fa-school text-xl"></i></div>
      </div>
    </div>
  </div>

  <div class="card bg-white border border-gray-200 shadow-sm no-print">
    <div class="card-body">
      
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div>
            <h2 class="text-xl font-bold text-gray-800">Rekapitulasi Potensi Siswa</h2>
            <p class="text-sm text-gray-500">Pilih kelas untuk melihat data.</p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <select id="classSelect" class="select select-bordered select-sm w-full md:w-48">
                <option disabled selected value="">-- Pilih Kelas --</option>
            </select>
            <button id="btnDownloadPDF" class="btn btn-sm btn-outline gap-2" disabled>
                <i class="fa-solid fa-file-pdf"></i> Download PDF
            </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="table w-full">
            <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                <tr>
                    <th class="w-10">No</th>
                    <th>Nama Siswa</th>
                    <th class="text-center">Nilai Akhir</th>
                    <th class="text-center">Potensi</th>
                    <th>Rekomendasi Singkat</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="5" class="text-center py-10 text-gray-400">Silakan pilih kelas terlebih dahulu.</td>
                </tr>
            </tbody>
        </table>
      </div>

    </div>
  </div>

  <dialog id="confirmModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
      <h3 class="font-bold text-lg"><i class="fa-solid fa-circle-info text-info"></i> Konfirmasi Download</h3>
      <p class="py-4">
        Anda akan mengunduh laporan PDF untuk kelas ini.<br>
        <span class="font-bold text-error text-sm">*Hanya siswa yang SUDAH DIPREDIKSI yang akan muncul dalam laporan.</span>
      </p>
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost">Batal</button>
          <button id="btnConfirmPrint" class="btn btn-primary text-white">Ya, Download</button>
        </form>
      </div>
    </div>
  </dialog>

  <div id="pdf-template" class="hidden font-sans text-black">
    
    <div class="border-b-2 border-black pb-4 mb-6">
        <h1 class="text-2xl font-bold uppercase text-center tracking-widest mb-1">Laporan Potensi Akademik</h1>
        <div class="flex justify-between text-sm font-bold mt-4">
            <span>KELAS: <span id="pdf-class-name">...</span></span>
            <span>TOTAL SISWA TERDATA: <span id="pdf-total-students">0</span></span>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="border border-black p-4 text-center rounded">
            <div class="text-xs font-bold uppercase mb-1">Potensi Aman</div>
            <div class="text-3xl font-black" id="pdf-count-aman">0</div>
        </div>
        <div class="border border-black p-4 text-center rounded">
            <div class="text-xs font-bold uppercase mb-1">Potensi Pantau</div>
            <div class="text-3xl font-black" id="pdf-count-pantau">0</div>
        </div>
        <div class="border border-black p-4 text-center rounded">
            <div class="text-xs font-bold uppercase mb-1">Potensi Bimbingan</div>
            <div class="text-3xl font-black" id="pdf-count-bimbingan">0</div>
        </div>
    </div>

    <table class="w-full text-xs border-collapse border border-black">
        <thead>
            <tr class="bg-gray-100">
                <th class="border border-black p-2 w-10 text-center">No</th>
                <th class="border border-black p-2 text-left">Nama Siswa</th>
                <th class="border border-black p-2 text-center w-24">Potensi</th>
                <th class="border border-black p-2 text-center w-20">Nilai Akhir</th>
                <th class="border border-black p-2 text-left">Rekomendasi</th>
            </tr>
        </thead>
        <tbody id="pdf-table-body">
            </tbody>
    </table>

    <div class="mt-8 text-[10px] text-right italic">
        Dicetak pada: <span id="pdf-date"></span>
    </div>
  </div>

</AdminLayout>

<script>
  import '../../scripts/pages/admin/dashboard.js';
</script>