---
// src/pages/guru/analisis-ai.astro
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import AlertSystem from '../../../components/ui/AlertSystem.astro';
---

<DashboardLayout title="Analisis AI & Prediksi">
    <AlertSystem />

    <style is:global>
        /* Di layar biasa: SEMBUNYIKAN TEMPLATE */
        .print-template {
            display: none;
        }
    
        @media print {
            /* Sembunyikan SEMUA elemen body */
            body > * {
                display: none !important;
            }
    
            /* Kecuali si Template (Kita akan pindahkan dia jadi anak langsung body via JS) */
            body > .print-template {
                display: block !important;
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
                background-color: white !important;
                z-index: 999999 !important;
                visibility: visible !important;
            }
    
            /* Reset margin halaman */
            @page {
                size: auto;
                margin: 0mm;
            }
        }
    </style>
    
    <div class="container mx-auto max-w-6xl space-y-6 px-4 pb-32 md:pb-10 md:space-y-8">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fa-solid fa-brain text-primary"></i> Analisis Performa AI
                </h1>
                <p class="text-gray-500 text-sm md:text-base mt-1">Sistem Cerdas Pendeteksi Potensi Akademik Siswa.</p>
            </div>
        </div>

        <div class="card bg-white shadow-sm border border-gray-200">
            <div class="card-body p-5 md:p-6">
                <div class="flex flex-col md:flex-row md:items-end gap-4">
                    <div class="form-control w-full md:max-w-md">
                        <label class="label pl-0">
                            <span class="label-text font-bold text-gray-700">Pilih Kelas</span>
                        </label>
                        <select id="classSelect" class="select select-bordered select-primary w-full bg-base-100">
                            <option disabled selected value="">-- Pilih Kelas --</option>
                        </select>
                    </div>
                    <div class="text-xs md:text-sm text-gray-400 pb-0 md:pb-3 flex items-center gap-1">
                        <i class="fa-solid fa-circle-info"></i> Data akan divalidasi otomatis.
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingValidation" class="hidden py-10 text-center">
            <span class="loading loading-dots loading-md text-gray-400"></span>
            <p class="text-xs text-gray-400 mt-2">Memeriksa kelengkapan data...</p>
        </div>

        <div id="studentSection" class="hidden transition-all duration-300 space-y-4">
            <div class="flex justify-between items-end">
                <h3 class="font-bold text-lg text-gray-700 border-l-4 border-primary pl-3">Status Data Siswa</h3>
                <div id="readinessCount" class="badge badge-lg badge-ghost font-bold">Menunggu...</div>
            </div>

            <div class="card bg-white shadow-sm border border-gray-200 overflow-hidden">
                <div class="w-full overflow-x-auto max-w-[calc(100vw-2rem)] md:max-w-full">
                    <table class="table table-sm w-full whitespace-nowrap">
                        <thead class="bg-gray-50 text-gray-600 font-bold uppercase text-xs">
                            <tr>
                                <th class="w-10 text-center">No</th>
                                <th>Nama Siswa</th>
                                <th>NISN</th>
                                <th class="text-center">Kelengkapan Data</th>
                                <th>Detail Masalah</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="text-sm"></tbody>
                    </table>
                </div>
                
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex flex-col-reverse sm:flex-row justify-between items-center gap-3">
                    <p class="text-xs text-gray-400 italic text-center sm:text-left">
                        *AI hanya memproses siswa <span class="text-success font-bold">SIAP</span>.
                    </p>
                    <button id="btnPredict" class="btn btn-primary w-full sm:w-auto shadow-md gap-2" disabled>
                        <i class="fa-solid fa-microchip"></i> Jalankan Analisis AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <dialog id="resultModal" class="modal modal-bottom sm:modal-middle backdrop-blur-sm">
        <div class="modal-box w-full max-w-5xl h-[90vh] sm:h-auto sm:max-h-[90vh] bg-gray-50 p-0 rounded-t-2xl sm:rounded-2xl flex flex-col">
            
            <div class="bg-white px-5 py-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-20 shadow-sm shrink-0">
                <div>
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-robot text-primary"></i> Hasil Analisis AI
                    </h3>
                    <p class="text-xs text-gray-500 mt-0.5" id="resultClassName">Kelas -</p>
                </div>
                <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost bg-gray-100 text-gray-500">âœ•</button></form>
            </div>

            <div id="printableArea" class="flex-1 overflow-y-auto p-5 space-y-6 bg-white sm:bg-gray-50">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <div class="bg-white p-4 rounded-xl border border-emerald-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Potensi Tinggi</p>
                            <h2 class="text-2xl font-black text-emerald-600 mt-1" id="statSafe">0</h2>
                            <span class="badge badge-xs badge-success text-white mt-1">Aman</span>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500"><i class="fa-solid fa-face-laugh-beam text-xl"></i></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-yellow-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Potensi Cukup</p>
                            <h2 class="text-2xl font-black text-yellow-600 mt-1" id="statWarning">0</h2>
                            <span class="badge badge-xs badge-warning text-white mt-1">Pantau</span>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-triangle-exclamation text-xl"></i></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-red-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Potensi Kurang</p>
                            <h2 class="text-2xl font-black text-red-600 mt-1" id="statDanger">0</h2>
                            <span class="badge badge-xs badge-error text-white mt-1">Bimbingan</span>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center text-red-500"><i class="fa-solid fa-land-mine-on text-xl"></i></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h4 class="font-bold text-gray-700 text-sm">Rincian & Rekomendasi</h4>
                        <span class="text-[10px] text-gray-400">AI Generated</span>
                    </div>
                    <div class="overflow-x-auto w-full">
                        <table class="table table-sm w-full">
                            <thead class="bg-white text-gray-500 font-bold uppercase border-b border-gray-100 text-xs">
                                <tr>
                                    <th class="pl-4">Siswa</th>
                                    <th class="text-center">Cluster</th>
                                    <th class="text-center">Status</th>
                                    <th>Rekomendasi Spesifik</th>
                                </tr>
                            </thead>
                            <tbody id="resultTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-200 shrink-0 flex justify-end gap-3">
                <form method="dialog"><button class="btn btn-ghost text-gray-500">Tutup</button></form>
                <button id="btnDownloadPDF" class="btn btn-error text-white gap-2 shadow-md">
                    <i class="fa-solid fa-print"></i> Cetak PDF
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <div id="aiProcessingOverlay" class="fixed inset-0 bg-black/70 z-50 hidden flex-col items-center justify-center text-white backdrop-blur-sm">
        <span class="loading loading-bars loading-lg text-primary mb-4 scale-150"></span>
        <h2 class="text-2xl font-bold">AI Sedang Bekerja...</h2>
        <p class="text-sm opacity-80 mt-1">Mengirim data ke Python Server & memproses algoritma.</p>
    </div>

    <div id="pdf-template" class="print-template">
        
        <div style="border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 24px; font-weight: bold; color: #000;">LAPORAN ANALISIS AI</h1>
            <table style="width: 100%; margin-top: 10px;">
                <tr>
                    <td style="text-align: left;"><strong>Kelas:</strong> <span id="pdf-class-name">-</span></td>
                    <td style="text-align: right;"><strong>Tanggal:</strong> <span id="pdf-print-date">-</span></td>
                </tr>
            </table>
        </div>

        <table style="width: 100%; border-collapse: separate; border-spacing: 10px; margin-bottom: 30px;">
            <tr>
                <td style="width: 33%; background-color: #f0fdf4; border: 1px solid #166534; padding: 15px; text-align: center;">
                    <div style="font-size: 14px; font-weight: bold; color: #166534; text-transform: uppercase;">AMAN</div>
                    <div id="pdf-stat-safe" style="font-size: 32px; font-weight: bold; color: #166534; margin: 5px 0;">0</div>
                    <div style="font-size: 11px; color: #166534;">Potensi Tinggi</div>
                </td>
                <td style="width: 33%; background-color: #fefce8; border: 1px solid #854d0e; padding: 15px; text-align: center;">
                    <div style="font-size: 14px; font-weight: bold; color: #854d0e; text-transform: uppercase;">PANTAU</div>
                    <div id="pdf-stat-warning" style="font-size: 32px; font-weight: bold; color: #854d0e; margin: 5px 0;">0</div>
                    <div style="font-size: 11px; color: #854d0e;">Potensi Cukup</div>
                </td>
                <td style="width: 33%; background-color: #fef2f2; border: 1px solid #991b1b; padding: 15px; text-align: center;">
                    <div style="font-size: 14px; font-weight: bold; color: #991b1b; text-transform: uppercase;">BIMBINGAN</div>
                    <div id="pdf-stat-danger" style="font-size: 32px; font-weight: bold; color: #991b1b; margin: 5px 0;">0</div>
                    <div style="font-size: 11px; color: #991b1b;">Potensi Kurang</div>
                </td>
            </tr>
        </table>

        <h3 style="margin-bottom: 10px; font-size: 16px; border-left: 5px solid #000; padding-left: 10px;">Detail Siswa</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px; width: 100%;">
            <thead>
                <tr style="background-color: #e5e7eb;">
                    <th style="border: 1px solid #9ca3af; padding: 10px; text-align: center; width: 40px;">No</th>
                    <th style="border: 1px solid #9ca3af; padding: 10px; text-align: left;">Nama Siswa & NISN</th>
                    <th style="border: 1px solid #9ca3af; padding: 10px; text-align: center; width: 100px;">Cluster</th>
                    <th style="border: 1px solid #9ca3af; padding: 10px; text-align: center; width: 100px;">Status</th>
                    <th style="border: 1px solid #9ca3af; padding: 10px; text-align: left;">Rekomendasi Tindakan</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
            </tbody>
        </table>

        <div style="margin-top: 40px; font-size: 10px; text-align: center; color: #666; border-top: 1px solid #ccc; padding-top: 10px;">
            Dicetak otomatis oleh Sistem AI Sekolah
        </div>
        
    </div> </DashboardLayout>

<script src="../../../scripts/pages/guru/analisis-ai.js"></script>